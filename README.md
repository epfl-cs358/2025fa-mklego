<p align=center> <img src=ressources/mklego-icon128.png> </p>

# CS-358 Project : MKLEGO 

 <p align=center><img src=ressources/readme-screenshots/Full_printer.png width=450> </p>

## Project overview

MKLEGO is a 3D printer that uses LEGO bricks to build any given structure layer by layer. The project is based on mofifying a PRUSA MK3 3D printer by 
- replacing the extruder with a custom nozzle that can pick, place and rotate LEGO bricks,
- changing the base plate to a LEGO compatible plate with place for custom LEGO brick dispensers,
- developing custom software to convert 3D models into LEGO brick instructions.


## Software
### How to run
Access the software repository here: [MKLEGO Software](/frontend/).
Run it by :

TODO: add instructions to run the software

### Pipeline
The JavaFX-based software pipeline includes:
- Loading a 3D model from an STL or lxfml (v5.0 Legacy LDD compatible) file,
- Slicing it into LEGO brick layers and assembling them in an optimal agencement,
- Rendering the LEGO structure in a 3D viewer to view and edit the build if needed,
- Generating the lgcode (custom g-code) instructions to be sent to the printer.


## Hardware architecture
 <p align=center><img src=ressources/readme-screenshots/schematic-overview.png> </p>

### Firmware
Access the firmware repository here: [MKLEGO Firmware](/backend/).

### System Overview

The hardware is organized around a **dual-microcontroller architecture**:

- **Main Controller**: STM32 Nucleo-64 (NUCLEO-F411RE)  
  Responsible for motion control (stepper motors), safety-critical timing, and real-time coordination.

- **Baseplate Controller**: ESP32-S3-DevKitC  
  Responsible for high-level logic, sensor acquisition, dispenser module control, and communication with the main controller.

The system integrates:
- Up to **6 LEGO dispenser modules**
- **3-axis stepper motor control (X, Y, Z)**
- A **servo motor** that pushes the brick down through the nozzle
- A centralized **power supply unit (PSU)** providing 5 V and 12 V rails

---

### Power Supply Unit (PSU)

The PSU provides three global rails distributed across the system:

- **+12 V**
  - Stepper motor drivers
  - High-power peripherals
- **+5 V**
  - Dispenser modules
  - Servo motor
  - Logic power where required
- **GND**
  - Common reference shared by all subsystems

All grounds are tied together to ensure a common electrical reference between the ESP32, STM32, motors, and peripherals.

---

### Main Microcontroller — STM32 Nucleo-64 (NUCLEO-F411RE)

The STM32 acts as the **real-time motion controller**.

#### Responsibilities
- Stepper motor pulse generation
- Direction control for all axes
- Servo PWM output
- Deterministic timing and synchronization

#### Stepper Motor Interface

Each axis uses a standard **STEP/DIR** interface:

| Axis | STEP Signal | DIR Signal |
|----|----|----|
| X | STEPX | DIRX |
| Y | STEPY | DIRY |
| Z | STEPZ | DIRZ |

These signals are routed to external stepper drivers powered from the 12 V rail.

#### Servo Control

- A dedicated **PWM output** drives the nozzle's servomotor.
- The servo is powered from **+5 V**, protected by a **polyfuse**.
- Common GND is shared with logic and motor drivers.

#### Debug & Programming

- On-board **ST-LINK** interface
- SWD signals exposed (SWDIO / SWCLK)
- USB provides programming and debugging access

---

### Baseplate Microcontroller — ESP32-S3-DevKitC

The ESP32-S3 serves as the **high-level controller and sensor hub**.

#### Responsibilities
- Control of LEGO dispenser modules
- Analog sensing via ADC channels
- PWM generation for dispenser actuation
- Communication with the STM32 (SPI bus)
- High-level logic and sequencing

#### Power

- Powered from the **+5 V rail**
- On-board regulation to 3.3 V for ESP32 core
- All ADC and logic signals referenced to system GND

---

### Dispenser Modules (Module 1–6)

Up to **six identical LEGO dispenser modules** can be connected.

#### Electrical Interface (per module)

Each dispenser connector provides:

- **+5 V** — module power
- **GND** — ground reference
- **PWMx** — control signal from ESP32
- **OUTx** — analog feedback signal

#### Control Signals

- **PWM1–PWM6**
  - Generated by ESP32 GPIOs
  - Used to actuate dispenser mechanisms (motors or solenoids)

#### Feedback Signals

- **OUT1–OUT6**
  - Routed through **100 Ω series resistors**
  - Connected to ESP32 ADC channels (ADC1 / ADC2)
  - Used for sensing (position, current, presence detection, or module state)

This architecture allows closed-loop or monitored dispensing of LEGO elements.

---

### Analog Signal Conditioning

Each dispenser feedback line includes:
- A **100 Ω resistor** in series
- Direct connection to an ESP32 ADC input

This provides:
- Basic current limiting
- Noise reduction
- Protection for ESP32 ADC pins

---

### Communication Between Controllers

#### SPI Bus

The ESP32 and STM32 are connected via an **SPI bus**, enabling:

- High-speed command transfer
- Deterministic motion commands
- Status and feedback reporting

This split architecture allows:
- ESP32 to manage high-level logic and sensors
- STM32 to focus exclusively on precise motor control

---

### Nozzle Servomotor

- Standard hobby servo
- Powered from **+5 V**
- PWM control signal from STM32
- Protected by a **polyfuse** to prevent over-current conditions

Used for:
- LEGO part placement
- Mechanical gating or release mechanisms







