#include <LiquidCrystal.h>
#include <SPI.h>
#include <SD.h>
//#include pitches.h

// LCD
const int rs=A0,en=A1,d4=5,d5=4,d6=3,d7=2;
LiquidCrystal lcd(rs,en,d4,d5,d6,d7);

// Other pins
const int buzzerPin=6,encA=7,encB=8,encBtn=A3,killBtn=9;
const int chipSelect=10,lcdBacklight=A2,sd=A4;

// --- Note frequencies ---
#define NOTE_B0  31
#define NOTE_C1  33
#define NOTE_CS1 35
#define NOTE_D1  37
#define NOTE_DS1 39
#define NOTE_E1  41
#define NOTE_F1  44
#define NOTE_FS1 46
#define NOTE_G1  49
#define NOTE_GS1 52
#define NOTE_A1  55
#define NOTE_AS1 58
#define NOTE_B1  62
#define NOTE_C2  65
#define NOTE_CS2 69
#define NOTE_D2  73
#define NOTE_DS2 78
#define NOTE_E2  82
#define NOTE_F2  87
#define NOTE_FS2 93
#define NOTE_G2  98
#define NOTE_GS2 104
#define NOTE_A2  110
#define NOTE_AS2 117
#define NOTE_B2  123
#define NOTE_C3  131
#define NOTE_CS3 139
#define NOTE_D3  147
#define NOTE_DS3 156
#define NOTE_E3  165
#define NOTE_F3  175
#define NOTE_FS3 185
#define NOTE_G3  196
#define NOTE_GS3 208
#define NOTE_A3  220
#define NOTE_AS3 233
#define NOTE_B3  247
#define NOTE_C4  262
#define NOTE_CS4 277
#define NOTE_D4  294
#define NOTE_DS4 311
#define NOTE_E4  330
#define NOTE_F4  349
#define NOTE_FS4 370
#define NOTE_G4  392
#define NOTE_GS4 415
#define NOTE_A4  440
#define NOTE_AS4 466
#define NOTE_B4  494
#define NOTE_C5  523
#define NOTE_CS5 554
#define NOTE_D5  587
#define NOTE_DS5 622
#define NOTE_E5  659
#define NOTE_F5  698
#define NOTE_FS5 740
#define NOTE_G5  784
#define NOTE_GS5 831
#define NOTE_A5  880
#define NOTE_AS5 932
#define NOTE_B5  988
#define NOTE_C6  1047
#define NOTE_CS6 1109
#define NOTE_D6  1175
#define NOTE_DS6 1245
#define NOTE_E6  1319
#define NOTE_F6  1397
#define NOTE_FS6 1480
#define NOTE_G6  1568
#define NOTE_GS6 1661
#define NOTE_A6  1760
#define NOTE_AS6 1865
#define NOTE_B6  1976
#define NOTE_C7  2093
#define NOTE_CS7 2217
#define NOTE_D7  2349
#define NOTE_DS7 2489
#define NOTE_E7  2637
#define NOTE_F7  2794
#define NOTE_FS7 2960
#define NOTE_G7  3136
#define NOTE_GS7 3322
#define NOTE_A7  3520
#define NOTE_AS7 3729
#define NOTE_B7  3951
#define NOTE_C8  4186
#define NOTE_CS8 4435
#define NOTE_D8  4699
#define NOTE_DS8 4978
// --- Note frequencies Pirates ---
#define NOTE_C4  262
#define NOTE_D4  294
#define NOTE_E4  330
#define NOTE_F4  349
#define NOTE_G4  392
#define NOTE_A4  440
#define NOTE_B4  494
#define NOTE_C5  523
#define NOTE_D5  587
#define NOTE_E5  659
#define NOTE_F5  698
#define NOTE_G5  784
#define NOTE_A5  880
#define NOTE_B5  988

// --- Icons ---
byte playIcon[8] = {B00000,B01000,B01100,B01110,B01100,B01000,B00000,B00000};
byte paintIcon[8]= {B00000,B11111,B10101,B11111,B00100,B00100,B00000,B00000};
byte musicIcon[8]= {  B00100,B00110,B00101,B00101,B01101,B11100,B11100,B00000};
byte homeIcon[8] = {B00100,B01010,B11111,B10001,B10001,B10001,B10001,B11111};

// --- Variables ---
int lastA=HIGH;
bool stopPlayback = false; //arreter la musique
int menuIndex=0;
int appState=0;  // 0=main menu, 1=SD browser
int fileIndex=0;
int fileCount=0;
String fileNames[20];

// ---------------------------------------------------------
void setup(){
  pinMode(encA,INPUT_PULLUP);
  pinMode(encB,INPUT_PULLUP);
  pinMode(encBtn,INPUT_PULLUP);
  pinMode(killBtn,INPUT_PULLUP);
  pinMode(buzzerPin,OUTPUT);
  pinMode(lcdBacklight,OUTPUT);
  analogWrite(lcdBacklight,180);

  lcd.begin(20,4);
  lcd.createChar(0, playIcon);
  lcd.createChar(1, paintIcon);
  lcd.createChar(2, musicIcon);
  lcd.createChar(3, homeIcon);

  showMainMenu();
}

void loop(){
  handleEncoder();
  handleButtons();
}

void handleEncoder(){
  int currentA=digitalRead(encA);
  if(currentA!=lastA){
    if(digitalRead(encB)!=currentA){
      if(appState==0) menuIndex++;
      else if(appState==1) fileIndex++;
    } else {
      if(appState==0) menuIndex--;
      else if(appState==1) fileIndex--;
    }
    tone(buzzerPin,1200,40);
    constrainIndices();
    if(appState==0) showMainMenu();
    if(appState==1) showFiles();
    delay(5);
  }
  lastA=currentA;
}

void handleButtons(){
  if(digitalRead(encBtn)==LOW){
    tone(buzzerPin,2000,80);
    delay(150);
    noTone(buzzerPin);

    if(appState==0){ openMenu(menuIndex); }
    else if(appState==1){ selectFile(); }
  }

  if(digitalRead(killBtn)==LOW){
    tone(buzzerPin, 400, 200);
    stopPlayback = true;        // signal that playback should stop
    appState = 0;
    showMainMenu();
    delay(300);
  }
}

void constrainIndices(){
  if(menuIndex<0)menuIndex=2;
  if(menuIndex>2)menuIndex=0;
  if(fileIndex<0)fileIndex=fileCount-1;
  if(fileIndex>=fileCount)fileIndex=0;
}

void showMainMenu(){
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.write(byte(3)); lcd.print(" Home");
  lcd.setCursor(13,0); lcd.print("MKlego");
  lcd.setCursor(0,1); lcd.write(byte(0)); lcd.print(" Print");
  lcd.setCursor(0,2); lcd.write(byte(1)); lcd.print(" Colors");
  lcd.setCursor(0,3); lcd.write(byte(2)); lcd.print(" Music");
  lcd.setCursor(18, menuIndex==0?1:(menuIndex==1?2:3));
  lcd.print("<");
}

void openMenu(int index){
  lcd.clear();
  switch(index){
    case 0:
      lcd.print("Opening SD browser");
      delay(800);
      listFiles();
      appState=1;
      showFiles();
      break;
    case 1:
      lcd.print("Colors menu empty");
      delay(1000);
      showMainMenu();
      break;
    case 2:
      lcd.clear();
      lcd.print("Play from SD :)");
      delay(500);
      listFiles();
      appState=1;
      showFiles();
      break;
  }
}

void listFiles(){
  fileCount=0;
  if(!SD.begin(chipSelect)){
    lcd.clear();
    lcd.print("SD init failed!");
    tone(buzzerPin,400,400);
    delay(800);
    appState=0;
    return;
  }
  File root=SD.open("/");
  while(true){
    File entry=root.openNextFile();
    if(!entry)break;
    if(!entry.isDirectory()){
      fileNames[fileCount++]=String(entry.name());
      if(fileCount>=20)break;
    }
    entry.close();
  }
  root.close();
  if(fileCount==0) fileNames[fileCount++]="No files found";
  fileIndex=0;
}

void showFiles(){
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("Files on SD:");
  for(int i=0;i<3 && i<fileCount;i++){
    int idx=(fileIndex+i)%fileCount;
    lcd.setCursor(0,i+1);
    lcd.print((idx==fileIndex)?"> ":"  ");
    lcd.print(fileNames[idx]);
  }
}

void selectFile() {
  lcd.clear();
  lcd.print("Selected:");
  lcd.setCursor(0, 1);
  lcd.print(fileNames[fileIndex]);
  tone(buzzerPin, 2000, 100);
  delay(200);

  String filename = fileNames[fileIndex];
  filename.trim();

  if (filename.endsWith(".TXT") || filename.endsWith(".txt")) {
    playSongFromSD(filename);
  } else {
    lcd.clear();
    lcd.print("Not a song file!");
    delay(1000);
  }

  showFiles();
}

void playSongFromSD(String filename) {
  File song = SD.open(filename);
  if (!song) {
    lcd.clear();
    lcd.print("Error opening song!");
    delay(1000);
    return;
  }

  lcd.clear();
  lcd.print("Playing: ");
  lcd.setCursor(0, 1);
  lcd.print(filename);
  delay(500);

  while (song.available()) {
    // Check if kill button was pressed
    if (digitalRead(killBtn) == LOW) {
      stopPlayback = true;
      break;
    }
    String note = song.readStringUntil('\n');
    note.trim();

    if (!song.available()) break; // avoid trying to read past EOF
    String durStr = song.readStringUntil('\n');
    durStr.trim();

    if (note.length() == 0 || durStr.length() == 0) continue;

    int duration = durStr.toInt();
    int freq = getNoteFrequency(note);
    int noteDuration = 1000 / duration;

    if (freq > 0) buzz(buzzerPin, freq, noteDuration);
    else delay(noteDuration);

    delay(noteDuration * 1);  // small gap between notes
  }

  song.close();
  lcd.clear();
  lcd.print("Done playing!");
  delay(1000);
}

int getNoteFrequency(String note) {
  note.toUpperCase();
  if (note == "REST" || note == "0") return 0;
  if (note == "C6") return NOTE_C6;
  if (note == "D6") return NOTE_D6;
  if (note == "E6") return NOTE_E6;
  if (note == "F6") return NOTE_F6;
  if (note == "G6") return NOTE_G6;
  if (note == "A6") return NOTE_A6;
  if (note == "B6") return NOTE_B6;
  if (note == "C7") return NOTE_C7;
  if (note == "D7") return NOTE_D7;
  if (note == "E7") return NOTE_E7;
  if (note == "G7") return NOTE_G7;
  if (note == "A7") return NOTE_A7;
  if (note == "AS6") return NOTE_AS6;
  if (note == "B7") return NOTE_B7;
  if (note == "G5") return NOTE_G5;
  if (note == "A5") return NOTE_A5;
  if (note == "B5") return NOTE_B5;
  if (note == "0") return 0; // rest

  // Octave 4
  if (note == "C4") return NOTE_C4;
  if (note == "D4") return NOTE_D4;
  if (note == "E4") return NOTE_E4;
  if (note == "F4") return NOTE_F4;
  if (note == "G4") return NOTE_G4;
  if (note == "A4") return NOTE_A4;
  if (note == "B4") return NOTE_B4;

  // Octave 5
  if (note == "C5") return NOTE_C5;
  if (note == "D5") return NOTE_D5;
  if (note == "E5") return NOTE_E5;
  if (note == "F5") return NOTE_F5;
  if (note == "G5") return NOTE_G5;
  if (note == "A5") return NOTE_A5;
  if (note == "B5") return NOTE_B5;

  // Optional: handle a few from octave 6 (just in case)
  if (note == "C6") return NOTE_C6;
  if (note == "D6") return NOTE_D6;
  if (note == "E6") return NOTE_E6;
  if (note == "F6") return NOTE_F6;
  if (note == "G6") return NOTE_G6;
  if (note == "A6") return NOTE_A6;
  if (note == "B6") return NOTE_B6;
  
  return 0;
}

// --- Tone function ---
void buzz(int targetPin, long frequency, long length){
  if(frequency==0){ delay(length); return; }
  long delayValue=1000000/frequency/2;
  long numCycles=frequency*length/1000;
  for(long i=0;i<numCycles;i++){
    digitalWrite(targetPin,HIGH);
    delayMicroseconds(delayValue);
    digitalWrite(targetPin,LOW);
    delayMicroseconds(delayValue);
  }
}
